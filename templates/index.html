<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Tingo Music Library</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@300;400;700&display=swap" rel="stylesheet" />
  <link rel="icon" href="data:,">
  <style>
    body{font-family:'Open Sans',sans-serif;background:#1A1A1A;color:#fff}
    .container{max-width:1000px;padding-top:4%}
    .card{background:linear-gradient(145deg,#232323,#1A1A1A);border:none;border-radius:25px;box-shadow:0 0 20px #D63384}
    .btn-primary{background:#D63384;border:none;border-radius:50px}
    .btn-primary:hover{background:#C82373}
    .form-control, .form-select{background:transparent;border-color:#eee;color:#fff}
    .form-control::placeholder{color:#ADB5BD}
    .audio-player{display:none;margin-top:20px}
    .list-group-item{background:#111;border-color:#333;color:#eee}
    #loader{display:none}
    a.btn{white-space:nowrap}
  </style>
</head>
<body>
<div class="container">
  <h1 class="text-center mb-1"><b>Welcome to Tingo AI Music Library</b></h1>
  <p class="text-center mb-4">Generate songs from text, upload your own music, or import from a direct URLâ€”then enjoy your album.</p>

  <!-- Create (AI) -->
  <div class="card mb-4">
    <div class="card-body">
      <h4 class="mb-3">Create AI Track</h4>
      <div class="row g-3">
        <div class="col-12">
          <textarea id="description" class="form-control" rows="3"
            placeholder="e.g., Triumphant cinematic Afrobeats with uplifting hookâ€¦"></textarea>
        </div>
        <div class="col-sm-8">
          <label class="form-label">Optional Title</label>
          <input id="title" class="form-control" placeholder="My New Track">
        </div>
        <div class="col-sm-4">
          <label class="form-label">Duration (0â€“20s)</label>
          <input type="range" class="form-range" id="durationSlider" min="0" max="20" value="10">
        </div>
      </div>
      <div class="d-grid mt-3">
        <button id="generateButton" class="btn btn-primary"><b>Generate</b> ðŸš€</button>
      </div>
      <div id="loader" class="text-center mt-4">
        <div class="spinner-grow text-warning" style="width:6rem;height:6rem" role="status"></div>
        <div class="mt-3" id="loaderText">Creating jobâ€¦</div>
      </div>
    </div>
  </div>

  <!-- Add Real Music -->
  <div class="card mb-4">
    <div class="card-body">
      <h4 class="mb-3">Add Your Music</h4>
      <div class="row g-3">
        <!-- Upload local file -->
        <div class="col-md-6">
          <div class="border rounded p-3">
            <h6>Upload Audio File</h6>
            <input type="file" id="uploadFile" class="form-control" accept="audio/*">
            <input type="text" id="uploadTitle" class="form-control mt-2" placeholder="Title (optional)">
            <input type="text" id="uploadArtist" class="form-control mt-2" placeholder="Artist (optional)">
            <div class="d-grid mt-2">
              <button id="btnUpload" class="btn btn-primary">Upload</button>
            </div>
            <small class="text-muted">Allowed: mp3, wav, ogg, webm, m4a (use files you have rights to).</small>
          </div>
        </div>
        <!-- Import by URL -->
        <div class="col-md-6">
          <div class="border rounded p-3">
            <h6>Import from Direct Audio URL</h6>
            <input type="text" id="importUrl" class="form-control" placeholder="https://example.com/song.mp3">
            <input type="text" id="importTitle" class="form-control mt-2" placeholder="Title (optional)">
            <input type="text" id="importArtist" class="form-control mt-2" placeholder="Artist (optional)">
            <div class="d-grid mt-2">
              <button id="btnImport" class="btn btn-primary">Import</button>
            </div>
            <small class="text-muted">Must be a direct audio link (mp3/wav/etc.). Do not use restricted sources.</small>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Now Playing -->
  <div class="card mb-4 audio-player" id="nowPlayingCard">
    <div class="card-body">
      <h4 class="mb-0">Now Playing: <span id="npTitle">â€”</span></h4>
      <div class="mt-1"><span class="badge bg-secondary" id="npTime"></span></div>
      <div class="text-muted" id="npArtist"></div>
      <p class="mt-3 mb-2" id="npLyrics" style="white-space:pre-wrap;"></p>
      <div id="waveform" class="mt-3"></div>
      <div class="mt-3 d-flex gap-2">
        <button id="btnPlayPause" class="btn btn-sm btn-primary">Play/Pause</button>
        <button id="btnStop" class="btn btn-sm btn-secondary">Stop</button>
        <button id="btnPrev" class="btn btn-sm btn-outline-light">Â« Prev</button>
        <button id="btnNext" class="btn btn-sm btn-outline-light">Next Â»</button>
        <a id="downloadLink" class="btn btn-sm btn-outline-info" download>Download</a>
      </div>
    </div>
  </div>

  <!-- Album -->
  <div class="card">
    <div class="card-body">
      <div class="d-flex justify-content-between align-items-center">
        <h4 class="mb-0">Your Album</h4>
        <div class="d-flex gap-2">
          <input type="time" id="scheduleTime" class="form-control form-control-sm" style="width:140px" />
          <button id="btnSchedule" class="btn btn-sm btn-outline-info">Schedule Play All</button>
          <button id="btnPlayAll" class="btn btn-sm btn-outline-light">Play All</button>
          <button id="btnRefresh" class="btn btn-sm btn-outline-secondary">Refresh</button>
        </div>
      </div>
      <ul id="albumList" class="list-group list-group flush mt-3"></ul>
    </div>
  </div>
</div>

<script src="https://unpkg.com/wavesurfer.js"></script>
<script>
  let wavesurfer = WaveSurfer.create({
    container: '#waveform',
    waveColor: '#b96ad9',
    progressColor: '#7a3fb0',
    cursorColor: '#ccc',
    height: 90
  });

  let album = [];
  let queue = [];
  let currentIndex = -1;
  let pollTimer = null;

  const $ = id => document.getElementById(id);

  function showNowPlaying(track){
    $('nowPlayingCard').style.display = 'block';
    $('npTitle').textContent = track.title || '(untitled)';
    $('npArtist').textContent = track.artist ? `Artist: ${track.artist}` : '';
    $('npLyrics').textContent = track.lyrics || '';
    $('downloadLink').href = track.url || '#';
    $('npTime').textContent = new Date(track.created_at || Date.now()).toLocaleString();

    if (track.url){
      wavesurfer.load(track.url);
    }
  }

  async function loadAlbum(){
    const res = await fetch('/api/album');
    album = await res.json();
    renderAlbum();
  }

  function renderAlbum(){
    const list = $('albumList');
    list.innerHTML = '';
    if (!album.length){
      list.innerHTML = '<li class="list-group-item">No tracks yet. Generate one above, upload, or import by URL.</li>';
      return;
    }
    album.forEach((t, idx) => {
      const li = document.createElement('li');
      li.className = 'list-group-item d-flex justify-content-between align-items-center';
      li.innerHTML = `
        <div>
          <strong>${t.title || '(untitled)'}</strong>
          ${t.artist ? `<div class="small">${t.artist}</div>` : ''}
          <div class="text-muted small">${t.created_at ? new Date(t.created_at).toLocaleString() : ''} â€¢ ${t.source || ''}</div>
        </div>
        <div class="d-flex align-items-center gap-2">
          <button class="btn btn-sm btn-primary" data-idx="${idx}" ${t.url ? '' : 'disabled'}>Play</button>
          ${t.url ? `<a class="btn btn-sm btn-outline-info" href="${t.url}" download>Download</a>` : ''}
          <button class="btn btn-sm btn-outline-danger" data-del="${t.id}">Delete</button>
        </div>`;
      li.querySelector('button[data-idx]')?.addEventListener('click', () => playSingle(idx));
      li.querySelector('button[data-del]')?.addEventListener('click', () => deleteTrack(t.id));
      list.appendChild(li);
    });
  }

  function playSingle(albumIndex){
    queue = [albumIndex];
    currentIndex = 0;
    playFromQueue();
  }

  function playAll(){
    queue = album.map((_, i) => i);
    currentIndex = 0;
    playFromQueue();
  }

  function playFromQueue(){
    if (currentIndex < 0 || currentIndex >= queue.length) return;
    const track = album[queue[currentIndex]];
    showNowPlaying(track);
  }

  // wavesurfer controls
  wavesurfer.on('ready', () => wavesurfer.play());
  wavesurfer.on('finish', () => {
    if (currentIndex >= 0 && currentIndex < queue.length - 1){
      currentIndex += 1;
      playFromQueue();
    }
  });

  $('btnPlayPause').onclick = () => wavesurfer.playPause();
  $('btnStop').onclick = () => wavesurfer.stop();
  $('btnNext').onclick = () => {
    if (currentIndex >= 0 && currentIndex < queue.length - 1){ currentIndex++; playFromQueue(); }
  };
  $('btnPrev').onclick = () => {
    if (currentIndex > 0){ currentIndex--; playFromQueue(); }
  };
  $('btnPlayAll').onclick = playAll;
  $('btnRefresh').onclick = loadAlbum;

  // Schedule (client-side)
  $('btnSchedule').onclick = () => {
    const t = $('scheduleTime').value; // "HH:MM"
    if (!t){ alert('Pick a time'); return; }
    const [hh, mm] = t.split(':').map(Number);
    const now = new Date();
    const when = new Date();
    when.setHours(hh, mm, 0, 0);
    if (when <= now) when.setDate(when.getDate() + 1);
    const ms = when - now;
    setTimeout(() => { playAll(); }, ms);
    alert('Scheduled at ' + when.toLocaleString());
  };

  // ---- Job flow (AI) ----
  async function pollJob(jobId){
    if (pollTimer) clearInterval(pollTimer);
    $('loaderText').textContent = 'Generating audioâ€¦';
    pollTimer = setInterval(async () => {
      try{
        const res = await fetch(`/job/${jobId}`);
        const data = await res.json();
        if (res.ok){
          const status = data?.job?.status;
          if (status === 'succeeded' && data.track){
            clearInterval(pollTimer);
            $('loader').style.display = 'none';
            showNowPlaying(data.track);
            await loadAlbum();
          } else if (status === 'failed' || status === 'canceled'){
            clearInterval(pollTimer);
            $('loader').style.display = 'none';
            alert('Generation failed: ' + (data.job?.error || status));
          } else {
            $('loaderText').textContent = `Generating audioâ€¦ (${status})`;
          }
        } else {
          clearInterval(pollTimer);
          $('loader').style.display = 'none';
          alert('Polling error. Please try again.');
        }
      } catch (e){
        clearInterval(pollTimer);
        $('loader').style.display = 'none';
        alert('Network error while polling.');
      }
    }, 3000);
  }

  $('generateButton').addEventListener('click', async () => {
    const prompt = $('description').value.trim();
    const title  = $('title').value.trim();
    const duration = $('durationSlider').value;
    if (!prompt){ alert('Please enter a description'); return; }

    $('loader').style.display = 'block';
    $('loaderText').textContent = 'Creating jobâ€¦';

    const fd = new FormData();
    fd.append('prompt', prompt);
    if (title) fd.append('title', title);
    fd.append('duration', duration);

    try{
      const res = await fetch('/generate-music', { method:'POST', body: fd });
      const result = await res.json();
      if (!res.ok){
        throw new Error(result.detail || result.error || 'Server error');
      }
      if (result.job && result.job.id){
        $('npLyrics').textContent = result.job.lyrics || '';
        $('npTitle').textContent = result.job.title || '';
        $('nowPlayingCard').style.display = 'block';
        pollJob(result.job.id);
      } else if (result.track) {
        $('loader').style.display = 'none';
        showNowPlaying(result.track);
        await loadAlbum();
      } else {
        throw new Error('Unexpected server response');
      }
    } catch (e){
      console.error(e);
      $('loader').style.display = 'none';
      alert('Failed to start generation: ' + e.message);
    }
  });

  // ---- Upload local file ----
  $('btnUpload').addEventListener('click', async () => {
    const f = $('uploadFile').files[0];
    if (!f){ alert('Choose an audio file'); return; }
    const fd = new FormData();
    fd.append('file', f);
    if ($('uploadTitle').value)  fd.append('title', $('uploadTitle').value);
    if ($('uploadArtist').value) fd.append('artist', $('uploadArtist').value);
    try{
      const res = await fetch('/api/album/upload', { method:'POST', body: fd });
      const data = await res.json();
      if (!res.ok) throw new Error(data.detail || data.error || 'Upload failed');
      await loadAlbum();
      showNowPlaying(data.track);
    } catch(e){
      alert(e.message);
    }
  });

  // ---- Import by direct URL ----
  $('btnImport').addEventListener('click', async () => {
    const url = $('importUrl').value.trim();
    if (!url){ alert('Enter a direct audio URL'); return; }
    try{
      const res = await fetch('/api/album/import_url', {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify({
          url,
          title: $('importTitle').value,
          artist: $('importArtist').value
        })
      });
      const data = await res.json();
      if (!res.ok) throw new Error(data.detail || data.error || 'Import failed');
      await loadAlbum();
      showNowPlaying(data.track);
    } catch(e){
      alert(e.message);
    }
  });

  // ---- Delete track ----
  async function deleteTrack(id){
    if (!confirm('Delete this track?')) return;
    const res = await fetch(`/api/album/${id}`, { method:'DELETE' });
    if (res.ok){
      await loadAlbum();
      // Stop playback if we deleted the current one
      if (currentIndex >= 0){
        wavesurfer.stop();
        $('nowPlayingCard').style.display = 'none';
      }
    } else {
      const data = await res.json().catch(()=>({}));
      alert('Delete failed: ' + (data.detail || data.error || res.status));
    }
  }

  // initial load
  loadAlbum();
</script>
</body>
</html>
